# Alembic Database Migrations

This directory contains Alembic database migrations for the DotMac Platform Services.

## üéØ Baseline Migration

**Current Baseline:** `b9f25627decc` (2025-09-30)

The baseline migration was generated from an **empty database** and creates the complete schema with **50 tables**. This ensures fresh installations can bootstrap from scratch. All new migrations **MUST** build on top of this baseline revision.

### Key Information

- **Baseline File:** `2025_09_30_0854-b9f25627decc_baseline_complete_schema.py`
- **Revision ID:** `b9f25627decc`
- **File Size:** 114KB (2,402 lines)
- **Tables Created:** 50 tables across all platform modules
- **Migration History:** Linear (no branches)
- **Generation Method:** Autogenerated from empty database against all models

## üì¶ Archived Migrations

All 23 prior migrations (with broken chains and merge conflicts) have been archived to:
```
alembic/versions_old_backup/
```

**Do not use archived migrations.** They contain broken revision chains and are kept only for historical reference.

## üöÄ Getting Started

### Fresh Database Setup

For a new database installation:

```bash
# 1. Ensure database exists and is accessible
docker-compose up -d postgres

# 2. Apply baseline migration
.venv/bin/alembic upgrade head

# 3. Verify migration applied
.venv/bin/alembic current
# Expected output: 639f12e6bc1d (head)
```

### Existing Database

If you have an existing database that was migrated with old migrations:

```bash
# 1. Backup your database first!
docker exec dotmac-postgres pg_dump -U dotmac_user -d dotmac > backup_$(date +%Y%m%d).sql

# 2. Database should already be stamped with baseline
.venv/bin/alembic current
# Should show: b9f25627decc (head)

# 3. If not stamped, manually stamp it
.venv/bin/alembic stamp head
```

## üîß Creating New Migrations

Always create new migrations from the baseline:

```bash
# 1. Modify your SQLAlchemy models in src/dotmac/platform/*/models.py

# 2. Generate migration
.venv/bin/alembic revision --autogenerate -m "descriptive_migration_name"

# 3. Review generated migration
# Check alembic/versions/<timestamp>-<hash>_descriptive_migration_name.py

# 4. Test migration
.venv/bin/alembic upgrade head

# 5. Verify schema matches models
.venv/bin/alembic check
```

### Migration Best Practices

1. **Always review autogenerated migrations** - Alembic may miss some changes
2. **Test both upgrade and downgrade** in development
3. **Add explicit `ondelete` behavior** to foreign keys
4. **Use `CONCURRENTLY` for indexes** on large tables (PostgreSQL)
5. **Never edit applied migrations** - create a new migration instead

## üìã Common Commands

```bash
# Check current migration
.venv/bin/alembic current

# View migration history
.venv/bin/alembic history --verbose

# Check if database schema matches models
.venv/bin/alembic check

# Upgrade to latest
.venv/bin/alembic upgrade head

# Upgrade to specific revision
.venv/bin/alembic upgrade <revision_id>

# Downgrade one revision
.venv/bin/alembic downgrade -1

# Downgrade to specific revision
.venv/bin/alembic downgrade <revision_id>

# Generate SQL without applying
.venv/bin/alembic upgrade head --sql

# Stamp database at specific revision (without running migration)
.venv/bin/alembic stamp <revision_id>
```

## ‚ö†Ô∏è Important Warnings

### Baseline Downgrade

The baseline migration includes a downgrade function, but **NEVER use it in production**:

```python
# ‚ùå NEVER DO THIS IN PRODUCTION
alembic downgrade base  # This will DROP ALL TABLES!
```

The downgrade is provided for development/testing only. For production rollbacks:
1. Restore from database backup
2. Roll back application code
3. Coordinate with DevOps team

### Production Checklist

Before applying migrations to production:

- [ ] Migration tested in development environment
- [ ] Migration tested in staging environment
- [ ] Database backup created
- [ ] Downtime window scheduled (if needed)
- [ ] Rollback plan prepared
- [ ] DevOps team notified

## üóÉÔ∏è Schema Coverage

The baseline migration creates **50 tables**:

| Module | Tables | Key Tables |
|--------|--------|------------|
| **Auth/RBAC** | 7 | users, roles, permissions, user_roles, role_permissions, user_permissions, permission_grants |
| **Billing** | 13 | invoices, payments, credit_notes, transactions, payment_methods, subscriptions, products, etc. |
| **Communications** | 3 | communication_templates, communication_logs, communication_stats |
| **Contacts** | 6 | contacts, contact_methods, contact_activities, contact_labels, contact_fields, etc. |
| **Customers** | 5 | customers, customer_segments, customer_activities, customer_notes, customer_tags |
| **Webhooks** | 2 | webhook_subscriptions, webhook_deliveries |
| **Audit** | 1 | audit_activities |
| **Data Import** | 2 | data_import_jobs, data_import_failures |
| **Banking/Cash** | 5 | company_bank_accounts, cash_registers, cash_transactions, cash_reconciliations, manual_payments |
| **Others** | 6+ | payment_reconciliations, role_hierarchy, customer_credits, payment_invoices, etc. |

**Total: 50 tables**

## üîç Troubleshooting

### "Target database is not up to date"

```bash
# Check what's different
.venv/bin/alembic check

# If differences are expected, generate new migration
.venv/bin/alembic revision --autogenerate -m "sync_schema"
```

### "Multiple heads detected"

This should never happen with the new baseline. If it does:

```bash
# Check heads
.venv/bin/alembic heads

# Create merge migration
.venv/bin/alembic merge -m "merge_heads" <revision1> <revision2>
```

### Alembic version table missing

```bash
# Recreate and stamp
.venv/bin/alembic stamp head
```

## üìö Resources

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy 2.0 Documentation](https://docs.sqlalchemy.org/en/20/)
- [PostgreSQL ALTER TABLE](https://www.postgresql.org/docs/current/sql-altertable.html)

## üìû Support

For migration issues:
1. Check this README
2. Review existing migrations in `alembic/versions/`
3. Consult with the platform team
4. Create an issue in the repository

---

**Last Updated:** 2025-09-30
**Baseline Revision:** `b9f25627decc`
**Tables Created:** 50
**File Size:** 114KB (2,402 lines)
**Generation Method:** From empty database
