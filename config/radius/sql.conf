# FreeRADIUS SQL Module Configuration
# PostgreSQL backend for RADIUS authentication and accounting

sql {
    dialect = "postgresql"
    driver = "rlm_sql_postgresql"

    # PostgreSQL connection
    server = "postgres"
    port = 5432
    login = "dotmac_user"
    password = "change-me-in-production"
    radius_db = "dotmac"

    # Connection pool
    pool {
        start = 5
        min = 4
        max = 32
        spare = 10
        uses = 0
        retry_delay = 30
        lifetime = 0
        idle_timeout = 60
    }

    # Read clients (NAS) from database
    read_clients = yes
    client_table = "nas"

    # Queries for authentication (radcheck)
    # Simplified without tenant filtering for initial testing
    authorize_check_query = "\
        SELECT id, username, attribute, value, op \
        FROM radcheck \
        WHERE username = '%{User-Name}' \
        ORDER BY id"

    authorize_reply_query = "\
        SELECT id, username, attribute, value, op \
        FROM radreply \
        WHERE username = '%{User-Name}' \
        ORDER BY id"

    # Group membership queries - Disabled for now (not using groups)
    # authorize_group_check_query = "\
    #     SELECT id, groupname, attribute, value, op \
    #     FROM radgroupcheck \
    #     WHERE groupname = '%{Sql-Group}' \
    #     ORDER BY id"

    # authorize_group_reply_query = "\
    #     SELECT id, groupname, attribute, value, op \
    #     FROM radgroupreply \
    #     WHERE groupname = '%{Sql-Group}' \
    #     ORDER BY id"

    # Accounting queries
    accounting {
        reference = "%{tolower:type.%{Acct-Status-Type}.query}"

        type {
            accounting-on {
                query = "\
                    UPDATE radacct \
                    SET acctstoptime = NOW(), \
                        acctterminatecause = '%{Acct-Terminate-Cause}' \
                    WHERE acctstoptime IS NULL \
                    AND nasipaddress = '%{NAS-IP-Address}' \
                    AND acctstarttime <= NOW()"
            }

            accounting-off {
                query = "\
                    UPDATE radacct \
                    SET acctstoptime = NOW(), \
                        acctterminatecause = '%{Acct-Terminate-Cause}' \
                    WHERE acctstoptime IS NULL \
                    AND nasipaddress = '%{NAS-IP-Address}' \
                    AND acctstarttime <= NOW()"
            }

            start {
                query = "\
                    INSERT INTO radacct \
                    (acctsessionid, acctuniqueid, username, realm, nasipaddress, \
                     nasportid, nasporttype, acctstarttime, acctupdatetime, \
                     acctsessiontime, acctauthentic, connectinfo_start, \
                     framedipaddress, framedprotocol, tenant_id, subscriber_id) \
                    VALUES \
                    ('%{Acct-Session-Id}', '%{Acct-Unique-Session-Id}', \
                     '%{User-Name}', NULLIF('%{Realm}', ''), '%{NAS-IP-Address}', \
                     NULLIF('%{NAS-Port}', '')::integer, '%{NAS-Port-Type}', NOW(), NOW(), \
                     0, '%{Acct-Authentic}', '%{Connect-Info}', \
                     NULLIF('%{Framed-IP-Address}', '')::inet, '%{Framed-Protocol}', \
                     'demo-alpha', NULL)"
            }

            interim-update {
                query = "\
                    UPDATE radacct \
                    SET acctupdatetime = NOW(), \
                        acctinputoctets = NULLIF('%{Acct-Input-Octets}', '')::bigint, \
                        acctoutputoctets = NULLIF('%{Acct-Output-Octets}', '')::bigint, \
                        acctsessiontime = NULLIF('%{Acct-Session-Time}', '')::integer \
                    WHERE acctsessionid = '%{Acct-Session-Id}' \
                    AND username = '%{User-Name}' \
                    AND nasipaddress = '%{NAS-IP-Address}'"
            }

            stop {
                query = "\
                    UPDATE radacct \
                    SET acctstoptime = NOW(), \
                        acctsessiontime = NULLIF('%{Acct-Session-Time}', '')::integer, \
                        acctinputoctets = NULLIF('%{Acct-Input-Octets}', '')::bigint, \
                        acctoutputoctets = NULLIF('%{Acct-Output-Octets}', '')::bigint, \
                        acctterminatecause = '%{Acct-Terminate-Cause}' \
                    WHERE acctsessionid = '%{Acct-Session-Id}' \
                    AND username = '%{User-Name}' \
                    AND nasipaddress = '%{NAS-IP-Address}'"
            }
        }
    }

    # Post-authentication logging
    post-auth {
        reference = ".query"
        query = "\
            INSERT INTO radpostauth \
            (username, password, reply, authdate, tenant_id) \
            VALUES \
            ('%{User-Name}', '%{%{User-Password}:-%{Chap-Password}}', \
             '%{reply:Packet-Type}', NOW(), 'demo-alpha')"
    }
}
