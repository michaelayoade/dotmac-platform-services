# FreeRADIUS Change of Authorization (CoA) Configuration
#
# This configuration enables RFC 5176 CoA/DM (Disconnect-Message) support
# for terminating active RADIUS sessions remotely.
#
# Installation:
# 1. Copy this file to /etc/freeradius/sites-available/coa
# 2. Create symlink: ln -s /etc/freeradius/sites-available/coa /etc/freeradius/sites-enabled/coa
# 3. Restart FreeRADIUS: systemctl restart freeradius

server coa {
    # Listen for CoA/DM packets on standard CoA port
    listen {
        type = coa
        ipaddr = *  # Listen on all interfaces
        port = 3799  # Standard CoA port (RFC 5176)

        # Limit source addresses (optional, for security)
        # Uncomment and adjust to restrict CoA requests to specific IPs
        # limit {
        #     max_connections = 16
        #     lifetime = 0
        #     idle_timeout = 30
        # }
    }

    # Handle incoming Change of Authorization requests
    recv-coa {
        # Log the CoA request
        update control {
            &Module-Success-Message = "CoA request received for user %{User-Name}"
        }

        # Accept the CoA request
        # FreeRADIUS will update the session attributes
        ok
    }

    # Handle incoming Disconnect-Message requests
    recv-disconnect {
        # Log the disconnect request
        update control {
            &Module-Success-Message = "Disconnect request received for user %{User-Name}"
        }

        # Accept the disconnect request
        # FreeRADIUS will terminate the session
        ok
    }

    # Send CoA ACK
    send-coa {
        ok
    }

    # Send Disconnect ACK
    send-disconnect {
        ok
    }
}

# Optional: Add CoA client configuration to allow ISP platform to send requests
# Add this to /etc/freeradius/clients.conf:
#
# client isp-platform {
#     ipaddr = 172.20.0.0/16  # Docker network or application server IP
#     secret = changeme_radius_shared_secret  # Match RADIUS_SECRET in .env
#     require_message_authenticator = no
#     shortname = isp-platform
#     nas_type = other
#
#     # Enable CoA for this client
#     coa_server {
#         server = coa
#     }
# }

# Example radclient command for testing:
#
# echo "User-Name=test@isp.com" | radclient -x localhost:3799 disconnect testing123
#
# Expected output:
# Sent Disconnect-Request Id 123 from 0.0.0.0:... to 127.0.0.1:3799 length 32
# Received Disconnect-ACK Id 123 from 127.0.0.1:3799 to 127.0.0.1:... length 20
