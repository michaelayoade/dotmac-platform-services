# Docker Compose for Platform Services Development
# Connects to existing dotmac-insights infrastructure

services:
  platform-backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dotmac-platform-backend
    command: uvicorn dotmac.platform.main:app --host 0.0.0.0 --port 8000 --reload
    restart: unless-stopped
    environment:
      ENVIRONMENT: development
      LOG_LEVEL: debug
      DEBUG: "true"
      # Database - matches docker-compose.infra.yml
      DATABASE__HOST: dotmac-postgres
      DATABASE__PORT: 5432
      DATABASE__DATABASE: dotmac
      DATABASE__USERNAME: dotmac_user
      DATABASE__PASSWORD: dev_local_pg_password_123
      DATABASE_URL: postgresql://dotmac_user:dev_local_pg_password_123@dotmac-postgres:5432/dotmac
      # Redis - matches docker-compose.infra.yml
      REDIS__HOST: dotmac-redis
      REDIS__PORT: 6379
      REDIS__DB: 5
      REDIS__PASSWORD: dev_local_redis_password_123
      REDIS_URL: redis://:dev_local_redis_password_123@dotmac-redis:6379/5
      SESSION_REDIS_URL: redis://:dev_local_redis_password_123@dotmac-redis:6379/6
      REQUIRE_REDIS_SESSIONS: "false"
      # Celery
      CELERY__BROKER_URL: redis://:dev_local_redis_password_123@dotmac-redis:6379/7
      CELERY__RESULT_BACKEND: redis://:dev_local_redis_password_123@dotmac-redis:6379/8
      # Secrets
      SECRET_KEY: dev-secret-key-change-me-min-32-chars
      AUTH__JWT_SECRET_KEY: dev-jwt-secret-key-change-me-min-32-chars
      # Storage - disabled for dev
      STORAGE__ENABLED: "false"
      VAULT__ENABLED: "false"
      # CORS
      CORS__ENABLED: "true"
      CORS__ORIGINS: '["http://localhost:3000","http://localhost:3002","http://localhost:8000","http://localhost:8001"]'
      CORS__CREDENTIALS: "true"
    ports:
      - "8001:8000"
    volumes:
      - ./src:/app/src:ro
      - platform_storage:/var/lib/dotmac
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/docs')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - dotmac-network

  platform-frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile.dev
    container_name: dotmac-platform-frontend
    restart: unless-stopped
    volumes:
      # Source code - live editing with hot reload
      - ./frontend/app:/app/frontend/app
      - ./frontend/components:/app/frontend/components
      - ./frontend/lib:/app/frontend/lib
      - ./frontend/providers:/app/frontend/providers
      - ./frontend/types:/app/frontend/types
      - ./frontend/public:/app/frontend/public
      # Config files
      - ./frontend/next.config.mjs:/app/frontend/next.config.mjs:ro
      - ./frontend/tailwind.config.ts:/app/frontend/tailwind.config.ts:ro
      - ./frontend/tsconfig.json:/app/frontend/tsconfig.json:ro
      - ./frontend/postcss.config.js:/app/frontend/postcss.config.js:ro
      - ./frontend/.env.local:/app/frontend/.env.local:ro
      # Preserve node_modules from container
      - frontend_node_modules:/app/frontend/node_modules
      - frontend_root_node_modules:/app/node_modules
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: http://localhost:8001
      NEXT_PUBLIC_API_BASE_URL: http://localhost:8001
      INTERNAL_API_URL: http://platform-backend:8000
      NEXT_PUBLIC_WS_URL: ws://localhost:8001
      NEXTAUTH_SECRET: dev-nextauth-secret-change-me-min-32-chars
      NEXTAUTH_URL: http://localhost:3002
      # Enable polling for file watching in Docker
      WATCHPACK_POLLING: "true"
      CHOKIDAR_USEPOLLING: "true"
    ports:
      - "3002:3000"
    depends_on:
      platform-backend:
        condition: service_started
    networks:
      - dotmac-network

volumes:
  platform_storage:
  frontend_node_modules:
  frontend_root_node_modules:

networks:
  dotmac-network:
    external: true
